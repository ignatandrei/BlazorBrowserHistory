@using Microsoft.AspNetCore.Components.Authorization
@inherits LayoutComponentBase
<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-4">
            <a href="https://learn.microsoft.com/aspnet/core/" target="_blank">About</a>
        </div>

        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

@code{
    [Inject]
    NavigationManager? NavigationManager { get; set; }
    string user = "";
    [Inject]
    BrowserHistory.Models.IBrowserUserHistoryRepository? browserUserHistoryRepository { get; set; }
    [Inject]
    IConfiguration? Config{ get; set; }
    void LocationChanged(object? sender, LocationChangedEventArgs e, string user)
    {
        var title = BBH.UI.MyInterop.GetTitle();

        string navigationMethod = e.IsNavigationIntercepted ? "HTML" : "code";
        System.Diagnostics.Debug.WriteLine($"Notified of navigation to {title} via {navigationMethod} to {e.Location}");
        if (browserUserHistoryRepository == null)
        {
            throw new InvalidOperationException("browserUserHistoryRepository is null , did you forgot to DI ?");
        }
        browserUserHistoryRepository.AddToMemory(new BrowserHistory.Models.BrowserUserHistoryData
        {
            Url = e.Location,
            UserName = user,
            Date = DateTime.UtcNow,
            PageName = title,
            AdditionalInfo = $"Intercepted {e.IsNavigationIntercepted} HistoryEntryState: {e.HistoryEntryState}"
        });

    }
    #region Current User - commented
    //do this if you read before
    //https://learn.microsoft.com/en-us/aspnet/core/blazor/security/authentication-state?view=aspnetcore-10.0&pivots=server
    // [Inject]
    // AuthenticationStateProvider? authenticationStateProvider { get; set; }

    protected async Task<string> GetCurrentUser()
    {
        return "";
        // var data = "Loading authentication state...";
        // if (authenticationStateProvider is null)
        // {
        //     data = "AuthenticationStateProvider is null.";
        //     return data;
        // }
        // var authState = await authenticationStateProvider.GetAuthenticationStateAsync();
        // var user = authState.User;
        // if (user.Identity is not null && user.Identity.IsAuthenticated)
        // {
        //     data = $"User is authenticated: {user.Identity.Name}";
        // }
        // else
        // {
        //     data = "User is not authenticated.";
        // }
        // return data;
    }
    #endregion
    protected override async Task OnInitializedAsync()
    {
        var basePath = Config?.GetValue<string>("AppBasePath") ?? "";
        await System.Runtime.InteropServices.JavaScript.JSHost.ImportAsync("InteropData", $"{basePath}_content/BBH.UI/exampleJsInterop.js");
        user = await GetCurrentUser();
        NavigationManager!.LocationChanged +=(s,e)=> LocationChanged(s,e, user); 

        await base.OnInitializedAsync();
    }
    public void Dispose()
   {
        NavigationManager!.LocationChanged -= (s, e) => LocationChanged(s, e, user); ;
   }
} 